import React, { useState, useEffect, useRef } from 'react';

const ManualeHub = () => {
  const canvasRef = useRef(null);
  const [hoveredSection, setHoveredSection] = useState(null);
  const [progress, setProgress] = useState({});
  
  // Sezioni del manuale
  const sections = [
    { id: 1, title: "L'Ascolto Profondo", color: "#1a4d6f", angle: 0, icon: "👂" },
    { id: 2, title: "Le Mappe di Risonanza", color: "#2d5c3f", angle: 51.4, icon: "🗺️" },
    { id: 3, title: "Il Linguaggio Essenziale", color: "#d4af37", angle: 102.8, icon: "🌳" },
    { id: 4, title: "Le Domande che Aprono", color: "#c0c0c0", angle: 154.2, icon: "🔑" },
    { id: 5, title: "Le Storie che Connettono", color: "#8b3a3a", angle: 205.6, icon: "🧵" },
    { id: 6, title: "Gli Strumenti Viventi", color: "#d97634", angle: 257, icon: "🧰" },
    { id: 7, title: "Il Venditore Risonante", color: "#6b4c9a", angle: 308.4, icon: "✨" }
  ];

  // Carica progresso da localStorage
  useEffect(() => {
    const saved = localStorage.getItem('manuale_progress');
    if (saved) setProgress(JSON.parse(saved));
  }, []);

  // Canvas: Spirale Aurea Vivente
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    
    const resize = () => {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    };
    
    resize();
    window.addEventListener('resize', resize);
    
    const PHI = 1.618033988749;
    let time = 0;
    
    const animate = () => {
      const w = canvas.width / dpr;
      const h = canvas.height / dpr;
      const cx = w / 2;
      const cy = h / 2;
      
      ctx.clearRect(0, 0, w, h);
      
      // Spirale aurea principale
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.3;
      
      ctx.beginPath();
      for (let i = 0; i < 360; i++) {
        const angle = i * Math.PI / 180;
        const radius = 10 * Math.pow(PHI, angle / (Math.PI / 2));
        const x = cx + radius * Math.cos(angle + time * 0.1);
        const y = cy + radius * Math.sin(angle + time * 0.1);
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
      
      // Nodi delle sezioni
      sections.forEach((section, idx) => {
        const angle = (section.angle + time * 5) * Math.PI / 180;
        const radius = 120 + Math.sin(time * 0.5 + idx) * 10;
        const x = cx + radius * Math.cos(angle);
        const y = cy + radius * Math.sin(angle);
        
        // Glow effect
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = section.color;
        ctx.shadowColor = section.color;
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(x, y, hoveredSection === idx ? 12 : 8, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        
        // Connessioni tra nodi
        if (idx < sections.length - 1) {
          const nextAngle = (sections[idx + 1].angle + time * 5) * Math.PI / 180;
          const nextX = cx + (120 + Math.sin(time * 0.5 + idx + 1) * 10) * Math.cos(nextAngle);
          const nextY = cy + (120 + Math.sin(time * 0.5 + idx + 1) * 10) * Math.sin(nextAngle);
          
          ctx.globalAlpha = 0.2;
          ctx.strokeStyle = '#d4af37';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(nextX, nextY);
          ctx.stroke();
        }
      });
      
      // Particelle respiranti
      for (let i = 0; i < 30; i++) {
        const angle = (i * 12 + time * 20) * Math.PI / 180;
        const radius = 60 + Math.sin(time + i * 0.5) * 20;
        const x = cx + radius * Math.cos(angle);
        const y = cy + radius * Math.sin(angle);
        
        ctx.globalAlpha = 0.3;
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      
      ctx.globalAlpha = 1;
      time += 0.01;
      requestAnimationFrame(animate);
    };
    
    animate();
    
    return () => window.removeEventListener('resize', resize);
  }, [hoveredSection]);

  const totalProgress = Object.keys(progress).length;
  const progressPercent = (totalProgress / sections.length) * 100;

  return (
    <div style={{
      minHeight: '100vh',
      background: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)',
      color: '#fafafa',
      fontFamily: "'Inter', -apple-system, sans-serif",
      position: 'relative',
      overflow: 'hidden'
    }}>
      <canvas
        ref={canvasRef}
        style={{
          position: 'fixed',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          pointerEvents: 'none',
          zIndex: 0
        }}
      />

      <header style={{
        position: 'relative',
        zIndex: 10,
        padding: '40px 20px',
        textAlign: 'center',
        borderBottom: '1px solid rgba(212, 175, 55, 0.2)'
      }}>
        <div style={{
          fontSize: '0.875rem',
          textTransform: 'uppercase',
          letterSpacing: '0.2em',
          color: '#d4af37',
          marginBottom: '10px',
          fontWeight: 500
        }}>
          Manuale del Venditore Risonante
        </div>
        <h1 style={{
          fontSize: 'clamp(2rem, 5vw, 3.5rem)',
          fontWeight: 700,
          letterSpacing: '-0.02em',
          margin: '10px 0 20px 0',
          lineHeight: 1.1
        }}>
          La Vendita che Risuona
        </h1>
        <p style={{
          fontSize: '1.25rem',
          color: '#737373',
          maxWidth: '600px',
          margin: '0 auto',
          lineHeight: 1.6
        }}>
          Non istruzioni da seguire, ma frequenze da riconoscere
        </p>
      </header>

      <div style={{
        position: 'relative',
        zIndex: 10,
        maxWidth: '800px',
        margin: '40px auto',
        padding: '0 20px'
      }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '10px',
          fontSize: '0.875rem',
          color: '#737373'
        }}>
          <span>Il Tuo Percorso</span>
          <span>{totalProgress}/7 frequenze esplorate</span>
        </div>
        <div style={{
          height: '4px',
          background: 'rgba(212, 175, 55, 0.2)',
          borderRadius: '2px',
          overflow: 'hidden'
        }}>
          <div style={{
            height: '100%',
            background: 'linear-gradient(90deg, #d4af37 0%, #b8941f 100%)',
            width: `${progressPercent}%`,
            transition: 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
            boxShadow: '0 0 20px rgba(212, 175, 55, 0.5)'
          }} />
        </div>
      </div>

      <main style={{
        position: 'relative',
        zIndex: 10,
        maxWidth: '1000px',
        margin: '60px auto',
        padding: '0 20px'
      }}>
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))',
          gap: '20px',
          marginTop: '40px'
        }}>
          {sections.map((section, idx) => (
            <div
              key={section.id}
              onMouseEnter={() => setHoveredSection(idx)}
              onMouseLeave={() => setHoveredSection(null)}
              style={{
                background: hoveredSection === idx 
                  ? `linear-gradient(135deg, ${section.color}22 0%, ${section.color}11 100%)`
                  : 'rgba(26, 26, 26, 0.6)',
                border: `2px solid ${hoveredSection === idx ? section.color : 'rgba(212, 175, 55, 0.2)'}`,
                borderRadius: '12px',
                padding: '30px',
                cursor: 'pointer',
                transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                transform: hoveredSection === idx ? 'translateY(-8px)' : 'translateY(0)',
                boxShadow: hoveredSection === idx 
                  ? `0 20px 40px ${section.color}44`
                  : 'none',
                backdropFilter: 'blur(10px)',
                position: 'relative',
                overflow: 'hidden'
              }}
            >
              {progress[section.id] && (
                <div style={{
                  position: 'absolute',
                  top: '15px',
                  right: '15px',
                  width: '8px',
                  height: '8px',
                  background: section.color,
                  borderRadius: '50%',
                  boxShadow: `0 0 10px ${section.color}`
                }} />
              )}

              <div style={{
                fontSize: '2.5rem',
                marginBottom: '15px',
                filter: hoveredSection === idx ? 'none' : 'grayscale(0.5)'
              }}>
                {section.icon}
              </div>
              
              <div style={{
                fontSize: '0.75rem',
                textTransform: 'uppercase',
                letterSpacing: '0.15em',
                color: section.color,
                marginBottom: '8px',
                fontWeight: 600
              }}>
                Sezione {section.id}
              </div>
              
              <h3 style={{
                fontSize: '1.25rem',
                fontWeight: 600,
                marginBottom: '12px',
                lineHeight: 1.3
              }}>
                {section.title}
              </h3>
              
              <div style={{
                fontSize: '0.875rem',
                color: '#737373',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                marginTop: '15px'
              }}>
                <span>Esplora</span>
                <span style={{
                  transform: hoveredSection === idx ? 'translateX(5px)' : 'translateX(0)',
                  transition: 'transform 0.3s ease'
                }}>
                  →
                </span>
              </div>
            </div>
          ))}
        </div>

        <div style={{
          marginTop: '80px',
          padding: '40px',
          background: 'rgba(212, 175, 55, 0.05)',
          border: '1px solid rgba(212, 175, 55, 0.2)',
          borderRadius: '12px',
          borderLeft: '4px solid #d4af37',
          backdropFilter: 'blur(10px)'
        }}>
          <blockquote style={{
            fontSize: '1.25rem',
            fontStyle: 'italic',
            lineHeight: 1.7,
            margin: 0,
            color: '#e5e5e5'
          }}>
            "Un venditore risonante non convince. Rivela. Non persuade. Amplifica ciò che il cliente già sente ma non ha ancora le parole per dire."
          </blockquote>
          <div style={{
            marginTop: '20px',
            fontSize: '0.875rem',
            color: '#d4af37',
            fontWeight: 500
          }}>
            — Dal Metodo EAR
          </div>
        </div>
      </main>

      <footer style={{
        position: 'relative',
        zIndex: 10,
        marginTop: '100px',
        padding: '40px 20px',
        borderTop: '1px solid rgba(212, 175, 55, 0.2)',
        textAlign: 'center'
      }}>
        <div style={{
          fontSize: '0.875rem',
          color: '#737373',
          marginBottom: '20px'
        }}>
          <p style={{ margin: '5px 0' }}>
            Versione 1.0 • Aggiornato {new Date().toLocaleDateString('it-IT')}
          </p>
          <p style={{ margin: '5px 0', color: '#d4af37' }}>
            Manuale vivente • Cresce con il team
          </p>
        </div>
        
        <div style={{
          fontSize: '0.75rem',
          color: '#525252',
          fontStyle: 'italic'
        }}>
          Premi F12 e scrivi: <code style={{ 
            background: 'rgba(212, 175, 55, 0.1)', 
            padding: '2px 6px', 
            borderRadius: '3px',
            color: '#d4af37'
          }}>Manuale.segreti()</code>
        </div>
      </footer>
    </div>
  );
};

if (typeof window !== 'undefined') {
  window.Manuale = {
    segreti: () => {
      console.log('%c🌀 HAI TROVATO LA FREQUENZA NASCOSTA', 'font-size: 20px; color: #d4af37; font-weight: bold;');
      console.log('%c\nTips Segreti:\n', 'font-size: 14px; color: #fafafa;');
      console.log('%c1. Se il cliente parla più di te, stai vincendo', 'color: #d4af37');
      console.log('%c2. La pausa è uno strumento, non un vuoto', 'color: #d4af37');
      console.log('%c3. Quando non sai cosa dire, fai una domanda onesta', 'color: #d4af37');
      console.log('%c4. Il "no" oggi può essere "sì" domani', 'color: #d4af37');
      console.log('%c5. Offri una frequenza, non un prodotto', 'color: #d4af37');
    }
  };
}

export default ManualeHub;
